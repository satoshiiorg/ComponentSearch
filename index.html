<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ボードゲームコンポーネント検索</title>
  </head>
  <body>
    <!--TODO UIというかデザインは見直す-->
    <h1>ボードゲームコンポーネント検索</h1>
    <p>はぐれたコンポーネントの写真からゲームタイトルを特定できたらいいな、というサービスです。</p>
    <h2>コンポーネント検索</h2>
    <form id="search_form">
      <!--同じ写真を選んで再検索できないのは微妙-->
      <lable>画像から検索: <input type="file" name="search_file" accept="image/*; capture=camera" /></lable>
      <!--<button type="button" name="re-search">再検索</button>-->
    </form>
    <p>(画像を選択すると自動的に検索されます)</p>
    <h2>コンポーネント登録</h2>
    <form id="register_form">
      <label>画像を登録: <input type="file" name="register_file" accept="image/*; capture=camera" /></label><br />
      <!-- TODO: サブフォームでマスタから検索できるように  -->
      <label>ゲームタイトル: <input type="text" name="register_title" placeholder="(ここにタイトルを入力)" required /></label><br />
      <input type="hidden" name="register_id" value="" />
      <button type="button" id="register_button">画像を登録</button>
    </form>
    <h2>実行結果</h2>
    <table id="result">
    </table>
<script>
  // 検索フォーム
  let xhr;
  document.getElementById("search_form").addEventListener('change', search);
  function search() {
    xhr = new XMLHttpRequest();
    // TODO エラー処理
    if (!xhr) {
      alert("エラーが発生しました");
      return false;
    }
    // TODO これずっと走ってるのか確認
    xhr.onreadystatechange = refreshResults;
    xhr.open('POST', '/cgi-bin/search.py');
    xhr.send(new FormData(document.getElementById("search_form")));
  }

  // titleとimage文字列からtr要素を生成
  // エスケープはこのメソッドで行う
  function tr(title, image) {
    const tr = document.createElement("tr");
    const td_title = document.createElement("td");
    td_title.textContent = title;
    const td_image = document.createElement("td");
    td_image.textContent = image;
    tr.appendChild(td_title);
    // TODO img要素
    tr.appendChild(td_image);
    return tr;
  }
  
  function refreshResults() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
      if (xhr.status === 200) {
        const results = JSON.parse(xhr.responseText);
        const table = document.getElementById("result");
        table.textContent = null;
        results.forEach(result => table.appendChild(tr(result.title, result.image)));
      } else {
        alert('リクエストに問題が発生しました');
      }
    }
  }
  
  //TODO さすがにコピペすぎるので何かしらフレームワーク使う
  document.getElementById("register_button").addEventListener('click', register);
  
  function register() {
    xhr = new XMLHttpRequest();
    // TODO エラー処理
    if (!xhr) {
      alert("エラーが発生しました");
      return false;
    }
    xhr.onreadystatechange = refreshResults;
    // xhr.onreadystatechange = () => alert("登録しました");
    xhr.open('POST', '/cgi-bin/register.py');
    xhr.send(new FormData(document.getElementById("register_form")));
  }
</script>
    
    <!-- ページ遷移版 script無効時にJSON変換はしたくない かといってXML断片返すのも -->
    <!-- TODO: 画面遷移なしで
    <!--onClickで送信して結果をプログレスバー表示から-->
    <!--React or Vue使う？-->
    <!--いずれにせよnoscript的にPOSTベースの実装も作る？-->
    <!--<form method="post" action="/cgi-bin/search.py" enctype="multipart/form-data">-->
      <!--<input type="file" accept="image/*; capture=camera" name="file" />-->
    <!--  検索したいコンポーネントの写真を指定して下さい: <br />-->
    <!--  <input type="file" name="file" /><br />-->
    <!--  <input type="submit" value="検索" />-->
    <!--</form>-->
  </body>
</html>
