<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ボードゲームコンポーネント検索</title>
  </head>
  <body>
    <h1>ボードゲームコンポーネント検索</h1>
    <p>はぐれたコンポーネントの写真からゲームタイトルを特定できたらいいな、というサービスです。</p>
    <form id="search_form">
      <!--同じ写真を選んで再検索できないのは微妙-->
    コンポーネントの写真を選択して検索: <br />
      <input type="file" name="file" accept="image/*; capture=camera" /><br />
      <!--<button type="button" name="re-search">再検索</button>-->
    </form>
    <table id="result">
    </table>
    <script>
  let xhr;
  document.getElementById("search_form").addEventListener('change', makeRequest);
  
  function makeRequest() {
    xhr = new XMLHttpRequest();
    // TODO エラー処理
    if (!xhr) {
      alert("エラーが発生しました");
      return false;
    }
    xhr.onreadystatechange = refreshContents;
    xhr.open('POST', '/cgi-bin/search.py');
    xhr.send(new FormData(document.getElementById("search_form")));
  }

  // titleとimage文字列からtr要素を生成
  // エスケープはこのメソッドで行う
  function tr(title, image) {
    const tr = document.createElement("tr");
    const td_title = document.createElement("td");
    td_title.textContent = title;
    const td_image = document.createElement("td");
    td_image.textContent = image;
    tr.appendChild(td_title);
    // TODO img要素
    tr.appendChild(td_image);
    return tr;
  }
  
  function refreshContents() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
      if (xhr.status === 200) {
        const results = JSON.parse(xhr.responseText);
        const table = document.getElementById("result");
        table.textContent = null;
        results.forEach(result => table.appendChild(tr(result.title, result.image)));
      } else {
        alert('リクエストに問題が発生しました');
      }
    }
  }
</script>
    
    <!-- ページ遷移版 script無効時にJSON変換はしたくない かといってXML断片返すのも -->
    <!-- TODO: 画面遷移なしで
    <!--onClickで送信して結果をプログレスバー表示から-->
    <!--React or Vue使う？-->
    <!--いずれにせよnoscript的にPOSTベースの実装も作る？-->
    <!--<form method="post" action="/cgi-bin/search.py" enctype="multipart/form-data">-->
      <!--<input type="file" accept="image/*; capture=camera" name="file" />-->
    <!--  検索したいコンポーネントの写真を指定して下さい: <br />-->
    <!--  <input type="file" name="file" /><br />-->
    <!--  <input type="submit" value="検索" />-->
    <!--</form>-->
  </body>
</html>
